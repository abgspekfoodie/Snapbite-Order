<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Snapbite™ Live Order</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #fff; padding: 1.5rem; max-width: 600px; margin: auto; }
  h1 { color: #ff9500; text-align: center; margin-bottom: 1rem; }
  label { display: block; margin-top: 1rem; font-weight: bold; }
  select, input[type="number"], input[type="text"], input[type="tel"], textarea {
    width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: none; background: #222; color: #fff; font-size: 1rem;
  }
  .menu-block {
    background: #1e1e1e; padding: 15px; margin-top: 20px; border-radius: 10px; position: relative;
  }
  .menu-block .remove-btn {
    position: absolute; top: 10px; right: 10px; background: #ff3b3b; border: none; color: #fff; padding: 5px 10px; border-radius: 6px; cursor: pointer;
    font-size: 0.9rem;
  }
  .addons, .sauces {
    margin-top: 10px;
  }
  .addons label, .sauces label {
    font-weight: normal;
    display: inline-block;
    margin-right: 15px;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .summary {
    background: #222; padding: 15px; border-radius: 10px; margin-top: 25px;
  }
  .summary h3 {
    margin-top: 0;
    color: #ff9500;
  }
  button.submit-btn {
    background: #ff9500; border: none; color: #000; padding: 15px; font-weight: bold; width: 100%; margin-top: 25px; border-radius: 10px; cursor: pointer;
    font-size: 1.1rem;
  }
  button.add-menu-btn {
    background: #0a84ff; border: none; color: #fff; padding: 12px; margin-top: 15px; border-radius: 8px; cursor: pointer; width: 100%;
    font-size: 1rem;
  }
</style>
</head>
<body>

<h1>Snapbite™ Live Order</h1>
<form id="orderForm">

  <label for="custName">Name</label>
  <input type="text" id="custName" required placeholder="Your name" autocomplete="name" />

  <label for="custPhone">Phone</label>
  <input type="tel" id="custPhone" required placeholder="Your phone number" autocomplete="tel" pattern="[0-9+]+" />

  <div id="menuContainer"></div>

  <button type="button" class="add-menu-btn" onclick="addMenu()">+ Add Menu Item</button>

  <label for="notes">Notes</label>
  <textarea id="notes" rows="3" placeholder="Additional instructions (optional)" autocomplete="off"></textarea>

  <div class="summary">
    <h3>Order Summary</h3>
    <ul id="orderSummary"></ul>
    <p><strong>Total: RM <span id="totalPrice">0.00</span></strong></p>
  </div>

  <button type="submit" class="submit-btn">Submit Order</button>
</form>

<script>
  // Firebase config - update with your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB_gnrfNMlJaNu6zSZqX7eiXzbZrnmtA2M",
    authDomain: "snapbite-admin.firebaseapp.com",
    databaseURL: "https://snapbite-admin-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "snapbite-admin",
    storageBucket: "snapbite-admin.appspot.com",
    messagingSenderId: "146625734660",
    appId: "1:146625734660:web:23ada593e4818ed7332d51"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Menu data by category
  const menuData = {
    "Beef": [
      { id: "primebite", name: "Primebite™", price: 10 },
      { id: "beefncheese", name: "Beef N’ Cheese™", price: 11 },
      { id: "thefunguy", name: "The Fun Guy™", price: 12 },
      { id: "thefixer", name: "The Fixer™", price: 15 }
    ],
    "Chicken": [
      { id: "chickbite", name: "Chickbite™", price: 9 },
      { id: "goldcut", name: "Goldcut™", price: 10 },
      { id: "thecapcut", name: "The Cap Cut™", price: 11 },
      { id: "stripstack", name: "Stripstack™", price: 14 }
    ],
    "Tex-Mex": [
      { id: "smokebeeftaco", name: "Smoke Beef Taco™", price: 10 },
      { id: "smokeychickentaco", name: "Smokey Chicken Taco™", price: 9 },
      { id: "mixtaco", name: "Mix Taco™", price: 12 },
      { id: "smokebeequesadilla", name: "Smoke Beef Quesadilla™", price: 15 },
      { id: "smokechickenquesadilla", name: "Smoke Chicken Quesadilla™", price: 14 },
      { id: "mixquesadilla", name: "Mix Quesadilla™", price: 16 }
    ],
    "Sausage": [
      { id: "classicsausage", name: "Classic Sausage™", price: 6 },
      { id: "loadedsausage", name: "Loaded Sausage™", price: 12 }
    ]
  };

  // Addons with category restriction
  const addonsData = [
    { id: "cheese", label: "Cheese", price: 2, applicableTo: ["all"] },
    { id: "beefPatty", label: "140gm Beef Patty", price: 6, applicableTo: ["Beef"] },
    { id: "egg", label: "Egg", price: 1, applicableTo: ["all"] },
    { id: "chickenPatty", label: "Chicken Patty", price: 4, applicableTo: ["Chicken"] },
    { id: "bacon", label: "Bacon", price: 3, applicableTo: ["all"] }
  ];

  // Sauces
  const saucesData = [
    "Redriot",
    "Whiteblaze"
  ];

  let menuCount = 0;

  function addMenu() {
    const container = document.getElementById("menuContainer");
    const block = document.createElement("div");
    block.className = "menu-block";
    block.dataset.id = menuCount;

    let html = `
      <button type="button" class="remove-btn" onclick="removeMenu(${menuCount})">Remove</button>
      <label>Category</label>
      <select class="category-select" onchange="onCategoryChange(this)" required>
        <option value="">-- Select Category --</option>
    `;
    Object.keys(menuData).forEach(cat => {
      html += `<option value="${cat}">${cat}</option>`;
    });
    html += `</select>`;

    html += `
      <label>Menu Item</label>
      <select class="menu-select" onchange="updateOrderSummary()" disabled required>
        <option value="">-- Select Menu Item --</option>
      </select>

      <label>Quantity</label>
      <input type="number" class="qty-input" min="1" value="1" onchange="updateOrderSummary()" required />

      <div class="addons">
        <label>Add-ons</label><br/>
    `;

    addonsData.forEach(addon => {
      html += `<label style="display:none"><input type="checkbox" class="addon-checkbox" data-id="${addon.id}" data-price="${addon.price}" onchange="updateOrderSummary()"> ${addon.label} RM${addon.price}</label>`;
    });
    html += `</div>`;

    html += `<div class="sauces"><label>Choice of Sauce</label><br/>`;
    saucesData.forEach((sauce, i) => {
      html += `<label><input type="radio" name="sauce-${menuCount}" value="${sauce}" onchange="updateOrderSummary()"> ${sauce}</label>`;
    });
    html += `</div>`;

    block.innerHTML = html;
    container.appendChild(block);
    menuCount++;
  }

  function removeMenu(id) {
    const block = document.querySelector(`.menu-block[data-id="${id}"]`);
    if (block) {
      block.remove();
      updateOrderSummary();
    }
  }

  function onCategoryChange(select) {
    const category = select.value;
    const block = select.closest(".menu-block");
    const menuSelect = block.querySelector(".menu-select");
    menuSelect.innerHTML = `<option value="">-- Select Menu Item --</option>`;
    if (category && menuData[category]) {
      menuData[category].forEach(item => {
        menuSelect.innerHTML += `<option value="${item.id}" data-price="${item.price}" data-name="${item.name}">${item.name} (RM${item.price})</option>`;
      });
      menuSelect.disabled = false;
    } else {
      menuSelect.disabled = true;
    }
    updateAddonVisibility(block, category);
    updateOrderSummary();
  }

  function updateAddonVisibility(block, category) {
    const addonLabels = block.querySelectorAll(".addons label");
    addonLabels.forEach(label => {
      const checkbox = label.querySelector("input.addon-checkbox");
      const addonId = checkbox.dataset.id;
      const addon = addonsData.find(a => a.id === addonId);
      if (!addon) return;
      if (addon.applicableTo.includes("all") || addon.applicableTo.includes(category)) {
        label.style.display = "inline-block";
      } else {
        label.style.display = "none";
        checkbox.checked = false;
      }
    });
  }

  function updateOrderSummary() {
    const orderSummary = document.getElementById("orderSummary");
    const totalPriceSpan = document.getElementById("totalPrice");
    let total = 0;
    orderSummary.innerHTML = "";

    const blocks = document.querySelectorAll(".menu-block");
    blocks.forEach(block => {
      const category = block.querySelector(".category-select").value;
      const menuSelect = block.querySelector(".menu-select");
      const qtyInput = block.querySelector(".qty-input");
      if (!category || !menuSelect.value) return;

      const selectedOption = menuSelect.options[menuSelect.selectedIndex];
      const basePrice = parseFloat(selectedOption.dataset.price);
      const name = selectedOption.dataset.name;
      const quantity = parseInt(qtyInput.value) || 1;

      // Addons price
      let addonsText = [];
      let addonsTotal = 0;
      block.querySelectorAll(".addon-checkbox:checked").forEach(cb => {
        const label = cb.parentElement.textContent.trim();
        const price = parseFloat(cb.dataset.price);
        addonsTotal += price;
        addonsText.push(label);
      });

      const saucesChecked = block.querySelector('input[type="radio"]:checked');
      const sauceText = saucesChecked ? saucesChecked.value : "";

      const itemTotal = (basePrice + addonsTotal) * quantity;
      total += itemTotal;

      let line = `${name} x${quantity}`;
      if (addonsText.length) line += " + " + addonsText.join(", ");
      if (sauceText) line += ` [Sauce: ${sauceText}]`;

      const li = document.createElement("li");
      li.textContent = `${line} = RM${itemTotal.toFixed(2)}`;
      orderSummary.appendChild(li);
    });

    totalPriceSpan.textContent = total.toFixed(2);
  }

  // On form submit
  document.getElementById("orderForm").addEventListener("submit", e => {
    e.preventDefault();

    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();
    const notes = document.getElementById("notes").value.trim();

    if (!name || !phone) {
      alert("Please fill in your name and phone.");
      return;
    }

    const orderItems = [];
    let valid = false;

    document.querySelectorAll(".menu-block").forEach(block => {
      const category = block.querySelector(".category-select").value;
      const menuSelect = block.querySelector(".menu-select");
      const qtyInput = block.querySelector(".qty-input");

      if (!category || !menuSelect.value) return;

      valid = true;

      const selectedOption = menuSelect.options[menuSelect.selectedIndex];
      const basePrice = parseFloat(selectedOption.dataset.price);
      const nameItem = selectedOption.dataset.name;
      const quantity = parseInt(qtyInput.value) || 1;

      const addons = [];
      block.querySelectorAll(".addon-checkbox:checked").forEach(cb => {
        addons.push({
          name: cb.parentElement.textContent.trim(),
          price: parseFloat(cb.dataset.price)
        });
      });

      const saucesChecked = block.querySelector('input[type="radio"]:checked');
      const sauce = saucesChecked ? saucesChecked.value : "";

      orderItems.push({
        category,
        name: nameItem,
        price: basePrice,
        quantity,
        addons,
        sauce
      });
    });

    if (!valid) {
      alert("Please select at least one menu item.");
      return;
    }

    let total = 0;
    orderItems.forEach(item => {
      let addonsTotal = item.addons.reduce((sum, a) => sum + a.price, 0);
      total += (item.price + addonsTotal) * item.quantity;
    });

    let msg = `Snapbite Order\nName: ${name}\nPhone: ${phone}\n\nOrder:\n`;
    orderItems.forEach(item => {
      let addonsTxt = item.addons.map(a => a.name).join(", ");
      let line = `- ${item.name} x${item.quantity}`;
      if (addonsTxt) line += ` + ${addonsTxt}`;
      if (item.sauce) line += ` [Sauce: ${item.sauce}]`;
      msg += line + "\n";
    });
    msg += `\nTotal: RM${total.toFixed(2)}`;
    if (notes) msg += `\nNotes: ${notes}`;

    // Save order to Firebase
    const orderData = {
      name,
      phone,
      notes,
      total,
      items: orderItems,
      status: "pending",
      timestamp: new Date().toISOString()
    };

    db.ref("orders").push(orderData, error => {
      if (error) {
        alert("Failed to save order. Please try again.");
      } else {
        const waUrl = "https://wa.me/60173209379?text=" + encodeURIComponent(msg);
        window.open(waUrl, "_blank");

        // Reset form & clear menu
        document.getElementById("orderForm").reset();
        document.getElementById("menuContainer").innerHTML = "";
        menuCount = 0;
        addMenu();
        updateOrderSummary();
      }
    });
  });

  // Init first menu item on page load
  addMenu();
  updateOrderSummary();
</script>

</body>
</html>
