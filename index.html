</option></select>`;

      html += `<label>Quantity</label><input type="number" class="qty" value="1" min="1" onchange="updateSummary()">`;

      html += `<div class="addons"><label>Add-ons</label><br/>`;
      addonsData.forEach(add => {
        html += `<label><input type="checkbox" class="addon" data-label="${add.label}" data-price="${add.price}" onchange="updateSummary()"> ${add.label} RM${add.price}</label>`;
      });
      html += `</div>`;

      html += `<div class="sauces"><label>Choose Sauce (Pick 2)</label><br/>`;
      saucesData.forEach(s => {
        html += `<label><input type="checkbox" class="sauce" name="sauce-${menuCount}" value="${s.label}" onchange="checkSauceLimit(this)"> ${s.label} (${s.desc})</label>`;
      });
      html += `</div>`;

      block.innerHTML = html;
      container.appendChild(block);
      menuCount++;

      loadMenuAvailability();
    }

    function removeMenu(id) {
      const block = document.querySelector(\`.menu-block[data-id="\${id}"]\`);
      if (block) block.remove();
      updateSummary();
    }

    function onCategoryChange(select) {
      const cat = select.value;
      const block = select.closest(".menu-block");
      const menuSelect = block.querySelector(".menu");
      menuSelect.innerHTML = `<option value="">-- Select Item --</option>`;
      menuSelect.disabled = !cat;

      if (cat) {
        db.ref("menuAvailability").once("value").then(snapshot => {
          const availData = snapshot.val() || {};
          menuData[cat].forEach(item => {
            if (availData[item.id] !== false) {
              menuSelect.innerHTML += \`<option value="\${item.id}" data-price="\${item.price}" data-desc="\${item.desc}">\${item.name} - \${item.desc} (RM\${item.price})</option>\`;
            }
          });
          updateSummary();
        });
      } else {
        updateSummary();
      }
    }

    function updateSummary() {
      let total = 0;
      const ul = document.getElementById("orderSummary");
      ul.innerHTML = "";

      document.querySelectorAll(".menu-block").forEach(block => {
        const menu = block.querySelector(".menu");
        const qty = parseInt(block.querySelector(".qty").value || 1);
        if (!menu || !menu.value) return;

        const itemName = menu.options[menu.selectedIndex].text;
        const itemPrice = parseFloat(menu.options[menu.selectedIndex].dataset.price);
        const addons = [...block.querySelectorAll(".addon:checked")].map(a => ({
          label: a.dataset.label,
          price: parseFloat(a.dataset.price)
        }));
        const sauces = [...block.querySelectorAll(".sauce:checked")].map(s => s.value);

        let line = \`\${itemName} x\${qty}\`;
        if (addons.length) line += " + " + addons.map(a => a.label).join(", ");
        if (sauces.length) line += \` [\${sauces.join(", ")}]\`;

        let itemTotal = (itemPrice + addons.reduce((sum, a) => sum + a.price, 0)) * qty;
        total += itemTotal;

        let li = document.createElement("li");
        li.textContent = \`\${line} = RM\${itemTotal.toFixed(2)}\`;
        ul.appendChild(li);
      });

      document.getElementById("totalPrice").textContent = total.toFixed(2);
    }

    function checkSauceLimit(clickedCheckbox) {
      const block = clickedCheckbox.closest(".menu-block");
      const checked = [...block.querySelectorAll(".sauce:checked")];
      if (checked.length > 2) {
        clickedCheckbox.checked = false;
        alert("You can select up to 2 sauces only per menu item.");
      }
      updateSummary();
    }

    function loadPickupTimes() {
      const select = document.getElementById("pickupTime");
      select.innerHTML = `<option value="">-- Select Pickup Time --</option>`;

      const now = new Date();
      now.setMinutes(now.getMinutes() + 15 - (now.getMinutes() % 15));
      for (let i = 0; i < 16; i++) {
        const optionTime = new Date(now.getTime() + i * 15 * 60000);
        const hh = optionTime.getHours().toString().padStart(2, "0");
        const mm = optionTime.getMinutes().toString().padStart(2, "0");
        const display = `${hh}:${mm}`;
        select.innerHTML += `<option value="${display}">${display}</option>`;
      }
    }

    function checkOffday() {
      db.ref("settings/offday").once("value").then(snap => {
        const isOff = snap.val() === true;
        if (isOff) {
          document.getElementById("orderForm").style.display = "none";
          document.getElementById("closedMsg").style.display = "block";
        } else {
          document.getElementById("orderForm").style.display = "block";
          document.getElementById("closedMsg").style.display = "none";
        }
      });
    }

    function loadMenuAvailability() {
      db.ref("menuAvailability").once("value").then(snap => {
        const availData = snap.val() || {};
        document.querySelectorAll(".menu-block").forEach(block => {
          const catSelect = block.querySelector(".category");
          const menuSelect = block.querySelector(".menu");
          if (!catSelect.value) return;
          if (menuSelect.disabled) return;

          const currentVal = menuSelect.value;

          menuSelect.innerHTML = `<option value="">-- Select Item --</option>`;
          menuData[catSelect.value].forEach(item => {
            if (availData[item.id] !== false) {
              menuSelect.innerHTML += `<option value="${item.id}" data-price="${item.price}" data-desc="${item.desc}">${item.name} - ${item.desc} (RM${item.price})</option>`;
            }
          });
          if ([...menuSelect.options].some(o => o.value === currentVal)) {
            menuSelect.value = currentVal;
          } else {
            menuSelect.value = "";
          }
        });
      });
    }

    document.getElementById("orderForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const name = document.getElementById("custName").value.trim();
      const phone = document.getElementById("custPhone").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const pickupTime = document.getElementById("pickupTime").value;

      if (!name || !phone) return alert("Please enter your name and phone.");
      if (!pickupTime) return alert("Please select a pickup time.");

      const items = [];
      document.querySelectorAll(".menu-block").forEach(block => {
        const menu = block.querySelector(".menu");
        const qty = parseInt(block.querySelector(".qty").value || 1);
        if (!menu || !menu.value) return;

        const itemName = menu.options[menu.selectedIndex].text;
        const itemId = menu.value;
        const itemPrice = parseFloat(menu.options[menu.selectedIndex].dataset.price);
        const addons = [...block.querySelectorAll(".addon:checked")].map(a => ({
          label: a.dataset.label,
          price: parseFloat(a.dataset.price)
        }));
        const sauces = [...block.querySelectorAll(".sauce:checked")].map(s => s.value);

        items.push({ id: itemId, name: itemName, quantity: qty, price: itemPrice, addons, sauces });
      });

      if (items.length === 0) return alert("Please add at least one menu item.");

      let total = items.reduce((sum, i) =>
        sum + ((i.price + i.addons.reduce((a, x) => a + x.price, 0)) * i.quantity), 0);

      let orderText = `Snapbiteâ„¢ Order\nName: ${name}\nPhone: ${phone}\nPickup Time: ${pickupTime}\n\nOrder Details:\n`;
      items.forEach(i => {
        orderText += `- ${i.name} x${i.quantity}`;
        if (i.addons.length) orderText += " + " + i.addons.map(a => a.label).join(", ");
        if (i.sauces.length) orderText += ` [Sauces: ${i.sauces.join(", ")}]`;
        orderText += `\n`;
      });
      orderText += `\nNotes: ${notes || "None"}\nTotal: RM${total.toFixed(2)}`;

      const newOrderRef = db.ref("orders").push();
      const orderId = newOrderRef.key;
      newOrderRef.set({
        id: orderId,
        name,
        phone,
        pickupTime,
        notes,
        items,
        total,
        status: "Pending",
        timestamp: Date.now()
      }).then(() => {
        const waNumber = "601120568858";
        const waUrl = `https://wa.me/${waNumber}?text=${encodeURIComponent(orderText)}`;

        alert(`Order submitted! Please click OK to open WhatsApp and send your order.`);
        window.open(waUrl, "_blank");

        const liveQueueUrl = `${window.location.origin}/live-queue.html?orderId=${orderId}`;
        alert(`You can also check your order status here:\n${liveQueueUrl}`);

        document.getElementById("orderForm").reset();
        document.getElementById("menuContainer").innerHTML = "";
        menuCount = 0;
        addMenu();
        updateSummary();
      }).catch(err => {
        alert("Failed to submit order, please try again.");
        console.error(err);
      });
    });

    // Init
    window.onload = () => {
      checkOffday();
      addMenu();
      loadPickupTimes();
      setInterval(loadPickupTimes, 5 * 60000); // update pickup times every 5 min
    };
  </script>
</body>
</html>
